<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Dashboard</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<!-- Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- MQTT & Charting Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0/dist/chartjs-plugin-streaming.min.js"></script>

<style>
    :root {
        --bg-color: #0f172a;
        --card-bg: #1e293b;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --accent-temp: #f59e0b;
        --accent-hum: #06b6d4;
        --success: #22c55e;
        --danger: #ef4444;
        --btn-off: #334155;
    }

    * { box-sizing: border-box; }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-primary);
        margin: 2rem;
        padding: 20px;
        min-height: 100vh;
    }

    /* Header & Status */
    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
    }

    h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    .status-pill {
        background: var(--card-bg);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #334155;
    }

    .status-dot {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        background-color: #64748b; /* Grey default */
        box-shadow: 0 0 0 0 rgba(100, 116, 139, 0.7);
    }

    .connected .status-dot {
        background-color: var(--success);
        animation: pulse-green 2s infinite;
    }

    .disconnected .status-dot {
        background-color: var(--danger);
    }

    @keyframes pulse-green {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    /* Grid Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border: 1px solid #334155;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    /* Metric Typography */
    .metric-value {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .metric-unit {
        font-size: 1.5rem;
        color: var(--text-secondary);
        font-weight: 400;
    }

    .metric-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: auto;
        display: flex;
        justify-content: space-between;
    }

    /* Specific Card Colors */
    .temp-icon { color: var(--accent-temp); }
    .hum-icon { color: var(--accent-hum); }
    
    /* Control Panel */
    .controls-wrapper {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }

    .btn {
        flex: 1;
        border: none;
        padding: 16px;
        border-radius: 12px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        background: var(--btn-off);
        border: 1px solid rgba(255,255,255,0.05);
    }

    .btn i { font-size: 1.4rem; }

    .btn.on-btn:hover { background-color: #15803d; }
    .btn.on-btn:active { transform: scale(0.98); }
    .btn.on-btn.active-state { background-color: var(--success); box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }

    .btn.off-btn:hover { background-color: #b91c1c; }
    .btn.off-btn:active { transform: scale(0.98); }
    .btn.off-btn.active-state { background-color: var(--danger); box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }

    .led-status-text {
        margin-top: 12px;
        text-align: center;
        font-size: 0.85rem;
        color: var(--text-secondary);
        background: rgba(0,0,0,0.2);
        padding: 6px;
        border-radius: 8px;
    }

    /* Chart Container */
    .chart-wrapper {
        position: relative;
        height: 350px;
        width: 100%;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
        .metric-value { font-size: 2.5rem; }
        .dashboard-grid { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

<header>
    <h1><i class="bi bi-cpu-fill" style="margin-right:10px;"></i>Environment Monitor</h1>
    <div id="status-container" class="status-pill">
        <div class="status-dot"></div>
        <span id="mqtt-status-text">Connecting...</span>
    </div>
</header>

<div class="dashboard-grid">
    <!-- Temperature Card -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-thermometer-half icon temp-icon" style="font-size: 1.2rem;"></i> 
            Temperature
        </div>
        <div class="metric-value">
            <span id="temperature">--</span><span class="metric-unit">°C</span>
        </div>
        <div class="metric-meta">
            <span>DHT Sensor</span>
            <span id="ts-temp">Waiting...</span>
        </div>
    </div>

    <!-- Humidity Card -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-moisture icon hum-icon" style="font-size: 1.2rem;"></i> 
            Humidity
        </div>
        <div class="metric-value">
            <span id="humidity">--</span><span class="metric-unit">%</span>
        </div>
        <div class="metric-meta">
            <span>DHT Sensor</span>
            <span id="ts-hum">Waiting...</span>
        </div>
    </div>

    <!-- LED Control Card -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-lightbulb-fill icon" style="font-size: 1.2rem; color: #fbbf24;"></i> 
            LED Control
        </div>
        <div class="controls-wrapper">
            <button class="btn on-btn" id="led-on">
                <i class="bi bi-power"></i> ON
            </button>
            <button class="btn off-btn" id="led-off">
                <i class="bi bi-slash-circle"></i> OFF
            </button>
        </div>
        <div class="led-status-text">
            State: <strong id="led-state" style="color:white;">UNKNOWN</strong>
        </div>
    </div>
</div>

<!-- Chart Section -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header">
        <i class="bi bi-graph-up"></i> Real-time History
    </div>
    <div class="chart-wrapper">
        <canvas id="sensor-chart"></canvas>
    </div>
</div>

<script>
    // ------------------------------------------------------------
    // CONFIGURATION
    // ------------------------------------------------------------
    const clientID = "web_ui_" + Math.random().toString(16).slice(2, 10);
    const host = "157.173.101.159";
    const wsPort = 9001;
    const wsPath = "/mqtt"; // Note: Standard Paho doesn't always use path this way, but keeping config
    
    const TOPIC_DATA = "sensors/dht";
    const TOPIC_LED_CMD = "control/led";
    const TOPIC_LED_STATE = "control/led/status";

    // ------------------------------------------------------------
    // MQTT CLIENT SETUP
    // ------------------------------------------------------------
    const client = new Paho.MQTT.Client(host, wsPort, clientID);

    // ------------------------------------------------------------
    // CHART SETUP
    // ------------------------------------------------------------
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = '#334155';
    
    const ctx = document.getElementById("sensor-chart").getContext("2d");
    
    // Gradients
    const gradientTemp = ctx.createLinearGradient(0, 0, 0, 400);
    gradientTemp.addColorStop(0, 'rgba(245, 158, 11, 0.5)'); // Orange
    gradientTemp.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

    const gradientHum = ctx.createLinearGradient(0, 0, 0, 400);
    gradientHum.addColorStop(0, 'rgba(6, 182, 212, 0.5)'); // Cyan
    gradientHum.addColorStop(1, 'rgba(6, 182, 212, 0.0)');

    const chart = new Chart(ctx, {
        type: "line",
        plugins: [ChartStreaming],
        data: {
            datasets: [
                { 
                    label: "Temp (°C)", 
                    data: [],
                    borderColor: '#f59e0b',
                    backgroundColor: gradientTemp,
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0
                },
                { 
                    label: "Humidity (%)", 
                    data: [],
                    borderColor: '#06b6d4',
                    backgroundColor: gradientHum,
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: false },
            plugins: { 
                legend: { labels: { color: '#f1f5f9' } },
                tooltip: { 
                    backgroundColor: 'rgba(15, 23, 42, 0.9)', 
                    titleColor: '#f1f5f9', 
                    bodyColor: '#cbd5e1', 
                    borderColor: '#334155', 
                    borderWidth: 1 
                }
            },
            scales: {
                x: {
                    type: "realtime",
                    realtime: {
                        duration: 60000,
                        refresh: 1000,
                        delay: 1000
                    },
                    grid: { color: '#334155' },
                    ticks: { color: '#94a3b8' }
                },
                y: { 
                    beginAtZero: true,
                    grid: { color: '#334155' },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });

    // ------------------------------------------------------------
    // UI LOGIC
    // ------------------------------------------------------------
    const statusContainer = document.getElementById("status-container");
    const statusText = document.getElementById("mqtt-status-text");

    function updateConnectionStatus(isConnected, message) {
        statusText.textContent = message;
        if (isConnected) {
            statusContainer.classList.add("connected");
            statusContainer.classList.remove("disconnected");
            statusText.style.color = "var(--success)";
        } else {
            statusContainer.classList.remove("connected");
            statusContainer.classList.add("disconnected");
            statusText.style.color = "var(--danger)";
        }
    }

    function formatTime(ts) {
        if (!ts) return "--:--:--";
        return new Date(ts).toLocaleTimeString();
    }

    function updateLEDUI(state) {
        const s = (state || "").toUpperCase();
        document.getElementById("led-state").textContent = s;
        
        const btnOn = document.getElementById("led-on");
        const btnOff = document.getElementById("led-off");

        // Visual feedback on buttons based on state
        if (s === "ON") {
            btnOn.classList.add("active-state");
            btnOff.classList.remove("active-state");
            // Make button text generic styles again
            btnOff.style.opacity = "0.5";
            btnOn.style.opacity = "1";
        } else if (s === "OFF") {
            btnOff.classList.add("active-state");
            btnOn.classList.remove("active-state");
            btnOn.style.opacity = "0.5";
            btnOff.style.opacity = "1";
        }
    }

    // ------------------------------------------------------------
    // MQTT CALLBACKS
    // ------------------------------------------------------------
    client.onMessageArrived = (message) => {
        const t = message.destinationName;
        
        if (t === TOPIC_DATA) {
            try {
                const data = JSON.parse(message.payloadString);
                const now = Date.now();

                // Update UI Numbers
                if (typeof data.temperature === "number") {
                    document.getElementById("temperature").textContent = data.temperature.toFixed(1);
                    chart.data.datasets[0].data.push({ x: now, y: data.temperature });
                }
                if (typeof data.humidity === "number") {
                    document.getElementById("humidity").textContent = data.humidity.toFixed(0);
                    chart.data.datasets[1].data.push({ x: now, y: data.humidity });
                }

                // Update Timestamps
                const timeStr = formatTime(now);
                document.getElementById("ts-temp").textContent = "Updated: " + timeStr;
                document.getElementById("ts-hum").textContent = "Updated: " + timeStr;

                chart.update("quiet");
            } catch (e) {
                console.error("Data parse error", e);
            }
        } else if (t === TOPIC_LED_STATE) {
            updateLEDUI(message.payloadString);
        }
    };

    client.onConnectionLost = (responseObject) => {
        updateConnectionStatus(false, "Disconnected");
        console.log("Connection Lost: " + responseObject.errorMessage);
    };

    // ------------------------------------------------------------
    // CONNECT & CONTROLS
    // ------------------------------------------------------------
    const connectOptions = {
        useSSL: false, // Ensure this matches your broker setup
        timeout: 10,
        onSuccess: () => {
            updateConnectionStatus(true, "Live Connected");
            client.subscribe(TOPIC_DATA);
            client.subscribe(TOPIC_LED_STATE);
        },
        onFailure: (err) => {
            updateConnectionStatus(false, "Failed: " + err.errorMessage);
        }
    };

    // Initial Connect
    try {
        client.connect(connectOptions);
    } catch (e) {
        updateConnectionStatus(false, "Init Error");
    }

    // Button Listeners
    document.getElementById("led-on").addEventListener("click", () => {
        const msg = new Paho.MQTT.Message("ON");
        msg.destinationName = TOPIC_LED_CMD;
        client.send(msg);
    });

    document.getElementById("led-off").addEventListener("click", () => {
        const msg = new Paho.MQTT.Message("OFF");
        msg.destinationName = TOPIC_LED_CMD;
        client.send(msg);
    });

</script>
</body>
</html>